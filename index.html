<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STUTGARD CPM | THE ULTIMATE PLATFORM</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/minecraftia" rel="stylesheet">

    <style>
        /* ========================================
           STUTGARD CPM - LUXURY DESIGN SYSTEM
           ========================================
        */
        :root {
            --st-cyan: #00f2ff;
            --st-blue: #0062ff;
            --st-bg: #030303;
            --st-card: #0d0d0f;
            --st-border: #222224;
            --st-text: #ffffff;
            --st-dim: #999999;
            --st-grad: linear-gradient(135deg, #0062ff, #00f2ff);
            --st-danger: #ff3b3b;
            --mc-font: 'Minecraftia', sans-serif;
        }

        /* Essential Reset & Anti-Zoom */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            touch-action: manipulation; 
        }

        html, body {
            margin: 0; padding: 0; 
            background: var(--st-bg); 
            color: var(--st-text);
            font-family: 'Inter', -apple-system, sans-serif; 
            overflow-x: hidden;
            width: 100%; height: 100%;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Minecraft Headings & Branding */
        h1, h2, h3, .st-logo, .mc-style, .st-btn, .admin-service-btn {
            font-family: var(--mc-font) !important;
            text-transform: uppercase;
        }

        /* ========================================
           PRELOADER SYSTEM
           ========================================
        */
        #st-preloader {
            position: fixed; inset: 0; background: #000; z-index: 100000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: 0.8s ease-in-out;
        }
        .st-loader-logo { font-size: 35px; font-weight: 900; letter-spacing: 2px; color: #fff; position: relative; }
        .st-loader-logo span { color: var(--st-cyan); }
        .st-progress-bar { width: 200px; height: 3px; background: #111; margin-top: 25px; border-radius: 5px; overflow: hidden; }
        .st-progress-fill { width: 0%; height: 100%; background: var(--st-grad); animation: fillProgress 2s forwards; }
        @keyframes fillProgress { 0% { width: 0%; } 100% { width: 100%; } }

        /* ========================================
           HEADER & NAVIGATION
           ========================================
        */
        .st-header {
            background: rgba(13, 13, 15, 0.9); backdrop-filter: blur(20px);
            padding: 15px 5%; border-bottom: 1px solid var(--st-border);
            position: sticky; top: 0; z-index: 1000; display: flex;
            justify-content: space-between; align-items: center;
        }
        .st-logo { font-size: 24px; text-decoration: none; color: #fff; }
        .st-logo span { color: var(--st-cyan); }

        .admin-controls-wrapper {
            display: flex; align-items: center; gap: 15px;
        }
        
        .admin-service-btn {
            background: #333; border: 2px solid #fff; color: #fff;
            padding: 5px 15px; font-size: 10px; cursor: pointer;
            box-shadow: -3px -3px 0px #111 inset, 3px 3px 0px #666 inset;
            display: none; /* Hidden by default */
        }
        .admin-service-btn:active { transform: translateY(2px); box-shadow: -1px -1px 0px #111 inset; }

        .st-user-pill {
            background: var(--st-border); padding: 8px 15px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px; font-size: 13px;
        }

        /* ========================================
           LAYOUT & SIDEBAR
           ========================================
        */
        .st-main-layout { display: flex; min-height: calc(100vh - 70px); }
        .st-sidebar {
            width: 260px; background: var(--st-card); border-left: 1px solid var(--st-border);
            padding: 20px 0; display: flex; flex-direction: column;
        }
        @media (max-width: 900px) { .st-sidebar { display: none; } }
        
        .st-nav-link {
            padding: 15px 30px; color: var(--st-dim); text-decoration: none;
            font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 15px;
            cursor: pointer; font-size: 14px;
        }
        .st-nav-link:hover, .st-nav-link.active { color: var(--st-cyan); background: rgba(0,242,255,0.05); }
        .st-nav-link i { font-size: 18px; width: 25px; text-align: center; }

        /* ========================================
           PAGES SYSTEM
           ========================================
        */
        .st-content { flex: 1; padding: 30px; overflow-y: auto; height: 90vh; }
        .st-page { display: none; animation: pageIn 0.4s ease-out; }
        .st-page.active { display: block; }
        @keyframes pageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ========================================
           HOME / HERO
           ========================================
        */
        .st-hero {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('https://wallpaperaccess.com/full/1883731.jpg');
            background-size: cover; background-position: center; border-radius: 30px;
            padding: 60px 40px; margin-bottom: 40px; border: 1px solid var(--st-border);
        }
        .st-search-bar {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 10px; display: flex; gap: 10px; margin-top: 25px;
        }
        .st-search-bar input {
            flex: 1; background: transparent; border: none; color: #fff; padding: 10px; font-size: 16px;
        }

        /* ========================================
           CAR CARDS GRID
           ========================================
        */
        .st-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .st-car-card {
            background: var(--st-card); border: 1px solid var(--st-border); border-radius: 25px;
            overflow: hidden; transition: 0.3s; position: relative;
        }
        .st-car-card:hover { transform: translateY(-5px); border-color: var(--st-cyan); }
        .st-car-img { width: 100%; height: 200px; object-fit: cover; background: #000; }
        .st-car-details { padding: 20px; }
        .st-car-price { font-size: 24px; font-weight: 900; color: var(--st-cyan); font-family: var(--mc-font); }
        .st-car-meta { display: flex; gap: 15px; font-size: 12px; color: var(--st-dim); margin-top: 10px; }

        /* ========================================
           UI COMPONENTS (BUTTONS / INPUTS)
           ========================================
        */
        .st-btn {
            padding: 12px 25px; border-radius: 12px; font-weight: 800; cursor: pointer;
            transition: 0.3s; border: none; text-align: center; display: inline-block;
            font-size: 12px;
        }
        .st-btn-main { background: var(--st-grad); color: #000; width: 100%; }
        .st-btn-outline { background: transparent; border: 1px solid var(--st-border); color: #fff; }
        .st-btn-danger { background: rgba(255, 59, 59, 0.1); color: var(--st-danger); border: 1px solid var(--st-danger); }

        .st-input, select, textarea {
            width: 100%; background: #000; border: 1px solid var(--st-border);
            padding: 15px; border-radius: 12px; color: #fff; margin-bottom: 15px;
            font-family: inherit;
        }

        /* ========================================
           CHAT SYSTEM UI
           ========================================
        */
        .st-chat-box {
            display: grid; grid-template-columns: 320px 1fr; height: 75vh;
            background: var(--st-card); border-radius: 30px; border: 1px solid var(--st-border); overflow: hidden;
        }
        @media (max-width: 850px) { .st-chat-box { grid-template-columns: 1fr; } }
        .st-chat-sidebar { border-left: 1px solid var(--st-border); background: rgba(255,255,255,0.02); overflow-y: auto; }
        .st-chat-contact {
            padding: 20px; border-bottom: 1px solid var(--st-border); cursor: pointer;
            display: flex; align-items: center; gap: 15px; transition: 0.2s;
        }
        .st-chat-contact:hover { background: rgba(0,242,255,0.05); }
        .st-chat-main { display: flex; flex-direction: column; background: #050505; }
        .st-chat-messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .st-bubble { max-width: 75%; padding: 14px 18px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
        .st-bubble.sent { align-self: flex-end; background: var(--st-blue); color: #fff; border-bottom-right-radius: 2px; }
        .st-bubble.received { align-self: flex-start; background: var(--st-border); color: #fff; border-bottom-left-radius: 2px; }
        .st-chat-input-area { padding: 20px; background: var(--st-card); border-top: 1px solid var(--st-border); display: flex; gap: 10px; }

        /* ========================================
           ADMIN / SERVICE OVERLAY
           ========================================
        */
        .st-admin-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            padding: 40px; display: none; overflow-y: auto;
        }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .st-admin-table { width: 100%; border-collapse: collapse; background: #0a0a0a; border: 1px solid var(--st-border); }
        .st-admin-table th { padding: 15px; background: #111; color: var(--st-cyan); text-align: right; font-family: var(--mc-font); font-size: 12px; }
        .st-admin-table td { padding: 15px; border-bottom: 1px solid var(--st-border); font-size: 14px; color: #ccc; }

        /* ========================================
           AUTH SCREEN
           ========================================
        */
        .st-auth-overlay {
            position: fixed; inset: 0; background: #000; z-index: 50000;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .st-auth-card {
            background: var(--st-card); padding: 45px; border-radius: 35px; border: 1px solid var(--st-border);
            width: 100%; max-width: 450px; text-align: center;
        }

        /* ========================================
           MOBILE NAVIGATION
           ========================================
        */
        .st-mobile-nav {
            display: none; position: fixed; bottom: 0; width: 100%; background: var(--st-card);
            border-top: 1px solid var(--st-border); z-index: 1000; justify-content: space-around; padding: 12px 0;
        }
        @media (max-width: 900px) { .st-mobile-nav { display: flex; } }
        .st-mob-item { text-align: center; color: var(--st-dim); font-size: 10px; cursor: pointer; flex: 1; }
        .st-mob-item.active { color: var(--st-cyan); }
        .st-mob-item i { font-size: 20px; display: block; margin-bottom: 5px; }

        /* Miscellaneous */
        .st-toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--st-cyan); color: #000;
            padding: 15px 30px; border-radius: 12px; font-weight: 800; z-index: 1000000; display: none;
            box-shadow: 0 10px 40px rgba(0,242,255,0.3); font-family: var(--mc-font); font-size: 11px;
        }
    </style>
</head>
<body>

    <div id="st-preloader">
        <div class="st-loader-logo mc-style">STUTGARD <span>CPM</span></div>
        <div class="st-progress-bar"><div class="st-progress-fill"></div></div>
        <p style="color:var(--st-dim); font-size:10px; margin-top:15px; font-family: var(--mc-font);">WORLD INITIALIZING...</p>
    </div>

    <div id="st-auth-gate" class="st-auth-overlay">
        <div class="st-auth-card" id="login-form">
            <h1 class="mc-style" style="margin:0; font-size: 24px;">STUTGARD <span>LOGIN</span></h1>
            <p style="color:var(--st-dim); margin-bottom:30px; font-size: 12px;">ENCRYPTED ACCESS TERMINAL</p>
            <input type="email" id="gate-email" class="st-input" placeholder="البريد الإلكتروني">
            <input type="password" id="gate-pass" class="st-input" placeholder="كلمة السر">
            <button class="st-btn st-btn-main mc-style" onclick="execLogin()">دخول العالم</button>
            <p style="margin-top:20px; font-size:12px;">ليس لديك تصريح؟ <span onclick="toggleAuthMode()" style="color:var(--st-cyan); cursor:pointer;">أنشئ حساباً</span></p>
        </div>
        <div class="st-auth-card" id="signup-form" style="display:none">
            <h1 class="mc-style" style="margin:0; font-size: 24px;">NEW <span>CITIZEN</span></h1>
            <p style="color:var(--st-dim); margin-bottom:30px; font-size: 12px;">CREATE GLOBAL IDENTITY</p>
            <input type="text" id="reg-name" class="st-input" placeholder="الاسم الكامل">
            <input type="email" id="reg-email" class="st-input" placeholder="البريد الإلكتروني">
            <input type="password" id="reg-pass" class="st-input" placeholder="كلمة السر">
            <button class="st-btn st-btn-main mc-style" onclick="execRegister()">تأكيد الهوية</button>
            <p style="margin-top:20px; font-size:12px;">لديك حساب؟ <span onclick="toggleAuthMode()" style="color:var(--st-cyan); cursor:pointer;">سجل دخولك</span></p>
        </div>
    </div>

    <div id="admin-service-panel" class="st-admin-overlay">
        <div class="admin-header">
            <h1 class="mc-style" style="color:var(--st-danger)">ADMIN <span>SERVICE</span></h1>
            <button class="admin-service-btn mc-style" style="display:block" onclick="closeAdminPanel()">X CLOSE</button>
        </div>
        <div style="overflow-x: auto;">
            <table class="st-admin-table">
                <thead>
                    <tr>
                        <th>اسم المستخدم</th>
                        <th>البريد الإلكتروني</th>
                        <th>كلمة السر</th>
                        <th>التاريخ</th>
                        <th>التحكم</th>
                    </tr>
                </thead>
                <tbody id="admin-user-list">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="st-main-app" style="display:none">
        
        <header class="st-header">
            <a href="#" class="st-logo mc-style">STUTGARD <span>CPM</span></a>
            <div class="admin-controls-wrapper">
                <button id="admin-trigger" class="admin-service-btn mc-style" onclick="openAdminPanel()">ADMIN SERVICE</button>
                <div class="st-user-pill">
                    <span id="header-user-name" class="mc-style" style="font-size:10px;">Guest</span>
                    <i class="fas fa-circle" style="color:var(--st-cyan); font-size:7px;"></i>
                </div>
            </div>
        </header>

        <div class="st-main-layout">
            <aside class="st-sidebar">
                <div class="st-nav-link active" onclick="switchPage('home', this)"><i class="fas fa-th-large"></i> سوق السيارات</div>
                <div class="st-nav-link" onclick="switchPage('messages', this)"><i class="fas fa-envelope"></i> الرسائل</div>
                <div class="st-nav-link" onclick="switchPage('post', this)"><i class="fas fa-plus-circle"></i> نشر إعلان</div>
                <div class="st-nav-link" onclick="switchPage('search', this)"><i class="fab fa-google"></i> بحث STUTGARD</div>
                <div class="st-nav-link" onclick="switchPage('dev', this)"><i class="fas fa-code"></i> المطورين</div>
                <div class="st-nav-link" style="margin-top:auto" onclick="location.reload()"><i class="fas fa-power-off"></i> خروج</div>
            </aside>

            <main class="st-content">

                <section id="page-home" class="st-page active">
                    <div class="st-hero">
                        <h1 class="mc-style" style="font-size:30px; margin:0">CPM MARKETPLACE</h1>
                        <p style="color:var(--st-dim); font-size:14px;">المنصة الأكبر لتداول السيارات عالمياً</p>
                        <div class="st-search-bar">
                            <i class="fas fa-search" style="padding:10px; color:var(--st-dim)"></i>
                            <input type="text" id="home-filter" placeholder="ابحث عن سيارة أحلامك..." onkeyup="filterContent()">
                        </div>
                    </div>
                    <div class="st-grid" id="cars-feed">
                        </div>
                </section>

                <section id="page-post" class="st-page">
                    <div style="max-width:700px; margin:auto; background:var(--st-card); padding:40px; border-radius:30px; border:1px solid var(--st-border);">
                        <h2 class="mc-style" style="margin-top:0">نشر إعلان جديد</h2>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <div>
                                <label style="display:block; margin-bottom:10px; font-size:12px;">اسم السيارة</label>
                                <input type="text" id="post-title" class="st-input" placeholder="مثلاً: G-Wagon 2025">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:10px; font-size:12px;">السعر (CPM)</label>
                                <input type="number" id="post-price" class="st-input" placeholder="00,000,000">
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <label style="display:block; margin-bottom:10px; font-size:12px;">صورة السيارة</label>
                            <input type="file" id="post-image" class="st-input" accept="image/*">
                        </div>
                        <button class="st-btn st-btn-main mc-style" style="margin-top:20px;" onclick="handlePublish()">تأكيد ونشر الإعلان</button>
                    </div>
                </section>

                <section id="page-messages" class="st-page">
                    <div class="st-chat-box">
                        <div class="st-chat-sidebar" id="contacts-list"></div>
                        <div class="st-chat-main">
                            <div id="chat-header" style="padding:20px; border-bottom:1px solid var(--st-border); font-weight:bold; font-size:14px;" class="mc-style">
                                CHAT TERMINAL
                            </div>
                            <div class="st-chat-messages" id="chat-body">
                                <div style="text-align:center; margin-top:100px; color:var(--st-dim)">
                                    <i class="fas fa-comments fa-3x" style="margin-bottom:20px;"></i>
                                    <p>اختر صديقاً لبدء المحادثة</p>
                                </div>
                            </div>
                            <div class="st-chat-input-area" id="chat-input-row" style="display:none">
                                <input type="text" id="msg-input" placeholder="اكتب رسالتك..." class="st-input" style="margin:0">
                                <button class="st-btn st-btn-main" style="width:auto" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="page-search" class="st-page">
                    <div class="st-hero" style="border-color:var(--st-cyan)">
                        <h2 class="mc-style">STUTGARD <span>ENGINE</span></h2>
                        <div class="st-search-bar">
                            <input type="text" id="google-query" placeholder="ابحث عن تعديلات أو أخبار CPM...">
                            <button class="st-btn st-btn-main" style="width:auto" onclick="openGoogle()">بحث</button>
                        </div>
                    </div>
                </section>

                <section id="page-dev" class="st-page">
                    <div style="background:#000; border:1px solid var(--st-cyan); padding:40px; border-radius:30px;">
                        <h2 class="mc-style">DEVELOPER <span>HUB</span></h2>
                        <p style="color:var(--st-dim)">نظام التذاكر المباشر للمطورين.</p>
                        <textarea id="dev-msg" class="st-input" style="height:150px" placeholder="ما هي الميزة التي تريد إضافتها؟"></textarea>
                        <button class="st-btn st-btn-outline mc-style" onclick="sendDevTicket()">إرسال للمراجعة</button>
                    </div>
                </section>

            </main>
        </div>

        <nav class="st-mobile-nav">
            <div class="st-mob-item active" onclick="switchPage('home', this)"><i class="fas fa-home"></i>الرئيسية</div>
            <div class="st-mob-item" onclick="switchPage('messages', this)"><i class="fas fa-comments"></i>الدردشة</div>
            <div class="st-mob-item" onclick="switchPage('post', this)"><i class="fas fa-plus"></i>نشر</div>
            <div class="st-mob-item" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i>خروج</div>
        </nav>
    </div>

    <div id="st-toast" class="st-toast"></div>

    <script>
        /* 1. Global State */
        let db_users = JSON.parse(localStorage.getItem('st_users')) || [
            { name: "Global Admin", email: "mustafabarbour5@gmail.com", pass: "Abd120120", role: "admin", date: "2024-01-01" }
        ];
        let db_ads = JSON.parse(localStorage.getItem('st_ads')) || [];
        let db_msgs = JSON.parse(localStorage.getItem('st_msgs')) || [];
        
        let session = null;
        let activeChat = null;

        /* 2. Persistence */
        function commit() {
            localStorage.setItem('st_users', JSON.stringify(db_users));
            localStorage.setItem('st_ads', JSON.stringify(db_ads));
            localStorage.setItem('st_msgs', JSON.stringify(db_msgs));
        }

        /* 3. Auth Logic */
        function toggleAuthMode() {
            const l = document.getElementById('login-form');
            const s = document.getElementById('signup-form');
            l.style.display = l.style.display === 'none' ? 'block' : 'none';
            s.style.display = s.style.display === 'none' ? 'block' : 'none';
        }

        function execRegister() {
            const n = document.getElementById('reg-name').value;
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;

            if(!n || !e || !p) return notify("أكمل البيانات أولاً!", "error");
            if(db_users.find(u => u.email === e)) return notify("الحساب موجود بالفعل!", "error");

            db_users.push({ name: n, email: e, pass: p, role: "user", date: new Date().toLocaleDateString() });
            commit();
            notify("تم إنشاء الحساب بنجاح!");
            toggleAuthMode();
        }

        function execLogin() {
            const e = document.getElementById('gate-email').value;
            const p = document.getElementById('gate-pass').value;
            const u = db_users.find(x => x.email === e && x.pass === p);

            if(u) {
                session = u;
                document.getElementById('st-auth-gate').style.display = 'none';
                document.getElementById('st-main-app').style.display = 'block';
                document.getElementById('header-user-name').innerText = u.name;
                
                if(u.role === 'admin') {
                    document.getElementById('admin-trigger').style.display = 'block';
                }
                
                renderHome();
                renderAdminUsers();
                notify("مرحباً بك في عالم STUTGARD");
            } else {
                notify("خطأ في البيانات!", "error");
            }
        }

        /* 4. Navigation Control */
        function switchPage(pId, el) {
            document.querySelectorAll('.st-page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pId).classList.add('active');
            
            // Side Nav UI
            document.querySelectorAll('.st-nav-link').forEach(l => l.classList.remove('active'));
            if(el.classList.contains('st-nav-link')) el.classList.add('active');
            
            // Mobile UI
            document.querySelectorAll('.st-mob-item').forEach(m => m.classList.remove('active'));
            if(el.classList.contains('st-mob-item')) el.classList.add('active');

            if(pId === 'messages') renderContacts();
        }

        /* 5. Listing Engine */
        function handlePublish() {
            const t = document.getElementById('post-title').value;
            const p = document.getElementById('post-price').value;
            const f = document.getElementById('post-image').files[0];

            if(!t || !p || !f) return notify("يرجى تعبئة كافة البيانات!", "error");

            const reader = new FileReader();
            reader.onload = function(e) {
                const ad = {
                    id: Date.now(),
                    title: t,
                    price: p,
                    img: e.target.result,
                    owner: session.name,
                    ownerEmail: session.email
                };
                db_ads.unshift(ad);
                commit();
                notify("تم نشر إعلانك بنجاح!");
                
                // Reset
                document.getElementById('post-title').value = "";
                document.getElementById('post-price').value = "";
                document.getElementById('post-image').value = "";
                
                switchPage('home', document.querySelector('.st-nav-link'));
                renderHome();
            };
            reader.readAsDataURL(f);
        }

        function renderHome(data = null) {
            const feed = document.getElementById('cars-feed');
            feed.innerHTML = "";
            const list = data || db_ads;

            if(list.length === 0) {
                feed.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:var(--st-dim);'>لا توجد سيارات معروضة حالياً.</p>";
            }

            list.forEach(ad => {
                feed.innerHTML += `
                    <div class="st-car-card">
                        <img src="${ad.img}" class="st-car-img">
                        <div class="st-car-details">
                            <div class="st-car-price">${parseInt(ad.price).toLocaleString()} CPM</div>
                            <h3 style="margin:10px 0; font-size:16px;">${ad.title}</h3>
                            <div class="st-car-meta">
                                <span><i class="fas fa-user"></i> ${ad.owner}</span>
                            </div>
                            <div style="margin-top:20px;">
                                ${ad.ownerEmail === session.email ? 
                                `<button class="st-btn st-btn-danger" style="width:100%" onclick="deleteAd(${ad.id})">حذف الإعلان</button>` :
                                `<button class="st-btn st-btn-main" onclick="openChatWith('${ad.ownerEmail}', '${ad.owner}')">تواصل بالدردشة</button>`}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function filterContent() {
            const q = document.getElementById('home-filter').value.toLowerCase();
            const f = db_ads.filter(a => a.title.toLowerCase().includes(q));
            renderHome(f);
        }

        function deleteAd(id) {
            if(confirm("هل أنت متأكد من حذف هذا الإعلان؟")) {
                db_ads = db_ads.filter(a => a.id !== id);
                commit();
                renderHome();
                notify("تم الحذف بنجاح");
            }
        }

        /* 6. Chat Engine */
        function openChatWith(email, name) {
            activeChat = { email, name };
            switchPage('messages', document.querySelectorAll('.st-nav-link')[1]);
            document.getElementById('chat-header').innerText = "الدردشة مع: " + name;
            document.getElementById('chat-input-row').style.display = 'flex';
            renderMessages();
        }

        function sendChatMessage() {
            const inp = document.getElementById('msg-input');
            if(!inp.value) return;

            db_msgs.push({
                from: session.email, fromN: session.name,
                to: activeChat.email, toN: activeChat.name,
                text: inp.value, time: Date.now()
            });

            commit();
            inp.value = "";
            renderMessages();
            renderContacts();
        }

        function renderMessages() {
            const body = document.getElementById('chat-body');
            body.innerHTML = "";
            const filtered = db_msgs.filter(m => 
                (m.from === session.email && m.to === activeChat.email) ||
                (m.to === session.email && m.from === activeChat.email)
            );

            filtered.forEach(m => {
                const side = m.from === session.email ? 'sent' : 'received';
                body.innerHTML += `<div class="st-bubble ${side}">${m.text}</div>`;
            });
            body.scrollTop = body.scrollHeight;
        }

        function renderContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = "";
            let cache = [];
            db_msgs.forEach(m => {
                if(m.from === session.email) cache.push({e: m.to, n: m.toN});
                if(m.to === session.email) cache.push({e: m.from, n: m.fromN});
            });

            const unique = Array.from(new Set(cache.map(x => x.e))).map(e => cache.find(c => c.e === e));

            unique.forEach(c => {
                list.innerHTML += `
                    <div class="st-chat-contact" onclick="openChatWith('${c.e}', '${c.n}')">
                        <div style="width:40px; height:40px; background:var(--st-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">${c.n[0]}</div>
                        <div>
                            <div style="font-weight:bold; font-size:13px;">${c.n}</div>
                            <div style="font-size:10px; color:var(--st-dim);">اضغط للمراسلة</div>
                        </div>
                    </div>`;
            });
        }

        /* 7. Admin Service Functions */
        function openAdminPanel() {
            document.getElementById('admin-service-panel').style.display = 'block';
            renderAdminUsers();
        }

        function closeAdminPanel() {
            document.getElementById('admin-service-panel').style.display = 'none';
        }

        function renderAdminUsers() {
            const container = document.getElementById('admin-user-list');
            container.innerHTML = "";
            db_users.forEach((u, i) => {
                if(u.role === 'admin') return;
                container.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td style="color:var(--st-cyan); font-family:monospace;">${u.pass}</td>
                        <td>${u.date || '---'}</td>
                        <td><button class="st-btn st-btn-danger" style="padding:5px 10px; font-size:10px;" onclick="banUser(${i})">حظر</button></td>
                    </tr>`;
            });
        }

        function banUser(i) {
            if(confirm("هل تريد حظر هذا المستخدم نهائياً؟")) {
                db_users.splice(i, 1);
                commit();
                renderAdminUsers();
                notify("تم حظر المستخدم");
            }
        }

        /* 8. Extra Features */
        function openGoogle() {
            const q = document.getElementById('google-query').value;
            if(!q) return;
            window.open("https://www.google.com/search?q=CPM+CAR+PARKING+" + encodeURIComponent(q), "_blank");
        }

        function sendDevTicket() {
            const m = document.getElementById('dev-msg').value;
            if(!m) return;
            notify("تم إرسال طلبك لفريق التطوير!");
            document.getElementById('dev-msg').value = "";
        }

        function notify(msg, type="success") {
            const t = document.getElementById('st-toast');
            t.innerText = msg;
            t.style.background = type === 'success' ? 'var(--st-cyan)' : 'var(--st-danger)';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        /* 9. Anti-Zoom Shield */
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });

        let lastTouch = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouch <= 300) e.preventDefault();
            lastTouch = now;
        }, false);

        /* Initializer */
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('st-preloader').style.opacity = '0';
                setTimeout(() => document.getElementById('st-preloader').style.display = 'none', 800);
            }, 2000);
        };

    </script>
</body>
</html>
