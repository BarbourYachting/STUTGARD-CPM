<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STUTGARD CPM | THE ULTIMATE PLATFORM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Root & Luxury Dark Theme */
        :root {
            --st-cyan: #00f2ff;
            --st-blue: #0062ff;
            --st-bg: #030303;
            --st-card: #0d0d0f;
            --st-border: #222224;
            --st-text: #ffffff;
            --st-dim: #999999;
            --st-grad: linear-gradient(135deg, #0062ff, #00f2ff);
            --st-danger: #ff3b3b;
        }

        /* Reset & Base Styles */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; background: var(--st-bg); color: var(--st-text);
            font-family: 'Inter', -apple-system, sans-serif; overflow-x: hidden;
        }

        /* Advanced Loading System */
        #st-preloader {
            position: fixed; inset: 0; background: #000; z-index: 100000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.8s ease-in-out;
        }
        .st-loader-logo { font-size: 35px; font-weight: 900; letter-spacing: 2px; color: #fff; position: relative; }
        .st-loader-logo span { color: var(--st-cyan); }
        .st-progress-bar { width: 200px; height: 3px; background: #111; margin-top: 25px; border-radius: 5px; overflow: hidden; }
        .st-progress-fill { width: 0%; height: 100%; background: var(--st-grad); animation: fillProgress 2s forwards; }
        @keyframes fillProgress { 0% { width: 0%; } 100% { width: 100%; } }

        /* Navigation Bar */
        .st-header {
            background: rgba(13, 13, 15, 0.9); backdrop-filter: blur(20px);
            padding: 15px 5%; border-bottom: 1px solid var(--st-border);
            position: sticky; top: 0; z-index: 1000; display: flex;
            justify-content: space-between; align-items: center;
        }
        .st-logo { font-size: 24px; font-weight: 900; text-decoration: none; color: #fff; }
        .st-logo span { color: var(--st-cyan); }
        .st-user-pill {
            background: var(--st-border); padding: 8px 15px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600;
        }

        /* Side Navigation */
        .st-main-layout { display: flex; min-height: calc(100vh - 70px); }
        .st-sidebar {
            width: 260px; background: var(--st-card); border-left: 1px solid var(--st-border);
            padding: 20px 0; display: flex; flex-direction: column;
        }
        @media (max-width: 900px) { .st-sidebar { display: none; } }
        .st-nav-link {
            padding: 15px 30px; color: var(--st-dim); text-decoration: none;
            font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 15px;
            cursor: pointer;
        }
        .st-nav-link:hover, .st-nav-link.active { color: var(--st-cyan); background: rgba(0,242,255,0.05); }
        .st-nav-link i { font-size: 18px; }

        /* Mobile Tab Bar */
        .st-mobile-nav {
            display: none; position: fixed; bottom: 0; width: 100%; background: var(--st-card);
            border-top: 1px solid var(--st-border); z-index: 1000; justify-content: space-around; padding: 10px 0;
        }
        @media (max-width: 900px) { .st-mobile-nav { display: flex; } }
        .st-mob-item { text-align: center; color: var(--st-dim); font-size: 10px; cursor: pointer; }
        .st-mob-item.active { color: var(--st-cyan); }
        .st-mob-item i { font-size: 20px; display: block; margin-bottom: 4px; }

        /* Main Container */
        .st-content { flex: 1; padding: 30px; overflow-y: auto; height: 90vh; }
        .st-page { display: none; animation: pageIn 0.5s ease; }
        .st-page.active { display: block; }
        @keyframes pageIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Home Dashboard */
        .st-hero {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://wallpaperaccess.com/full/1883731.jpg');
            background-size: cover; background-position: center; border-radius: 30px;
            padding: 60px 40px; margin-bottom: 40px; border: 1px solid var(--st-border);
        }
        .st-search-bar {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 10px; display: flex; gap: 10px; margin-top: 25px;
        }
        .st-search-bar input {
            flex: 1; background: transparent; border: none; color: #fff; padding: 10px; font-size: 16px;
        }

        /* Listings Grid */
        .st-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .st-car-card {
            background: var(--st-card); border: 1px solid var(--st-border); border-radius: 25px;
            overflow: hidden; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .st-car-card:hover { transform: translateY(-10px); border-color: var(--st-cyan); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .st-car-img { width: 100%; height: 200px; object-fit: cover; }
        .st-car-details { padding: 20px; }
        .st-car-price { font-size: 24px; font-weight: 900; color: var(--st-cyan); }
        .st-car-meta { display: flex; gap: 15px; font-size: 12px; color: var(--st-dim); margin-top: 10px; }

        /* Buttons */
        .st-btn {
            padding: 12px 25px; border-radius: 12px; font-weight: 800; cursor: pointer;
            transition: 0.3s; border: none; text-align: center; display: inline-block;
        }
        .st-btn-main { background: var(--st-grad); color: #000; width: 100%; }
        .st-btn-outline { background: transparent; border: 1px solid var(--st-border); color: #fff; }

        /* Chat UI Professional */
        .st-chat-box {
            display: grid; grid-template-columns: 320px 1fr; height: 80vh;
            background: var(--st-card); border-radius: 30px; border: 1px solid var(--st-border); overflow: hidden;
        }
        @media (max-width: 800px) { .st-chat-box { grid-template-columns: 1fr; } }
        .st-chat-sidebar { border-left: 1px solid var(--st-border); background: rgba(255,255,255,0.02); }
        .st-chat-contact {
            padding: 20px; border-bottom: 1px solid var(--st-border); cursor: pointer;
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
        }
        .st-chat-contact:hover, .st-chat-contact.active { background: rgba(0,242,255,0.1); }
        .st-chat-main { display: flex; flex-direction: column; background: #050505; }
        .st-chat-messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .st-bubble { max-width: 70%; padding: 14px 20px; border-radius: 20px; font-size: 14px; position: relative; }
        .st-bubble.sent { align-self: flex-end; background: var(--st-blue); color: #fff; border-bottom-right-radius: 2px; }
        .st-bubble.received { align-self: flex-start; background: var(--st-border); color: #fff; border-bottom-left-radius: 2px; }
        .st-chat-input-area { padding: 20px; background: var(--st-card); border-top: 1px solid var(--st-border); display: flex; gap: 10px; }

        /* Developer Hub UI */
        .st-dev-hero { background: #000; border: 1px solid var(--st-cyan); padding: 40px; border-radius: 30px; position: relative; }
        .st-dev-status { color: var(--st-cyan); font-family: monospace; font-size: 14px; }
        .st-dev-ticket { background: #111; border: 1px solid var(--st-border); padding: 20px; border-radius: 15px; margin-top: 15px; }

        /* Auth Screen */
        .st-auth-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .st-auth-card {
            background: var(--st-card); padding: 45px; border-radius: 35px; border: 1px solid var(--st-border);
            width: 100%; max-width: 450px; text-align: center;
        }
        .st-input {
            width: 100%; background: #000; border: 1px solid var(--st-border);
            padding: 15px; border-radius: 12px; color: #fff; margin-bottom: 15px;
        }

        /* Admin UI */
        .st-admin-table { width: 100%; border-collapse: collapse; background: var(--st-card); border-radius: 15px; overflow: hidden; }
        .st-admin-table th { padding: 15px; background: #151517; text-align: right; color: var(--st-cyan); font-size: 13px; }
        .st-admin-table td { padding: 15px; border-bottom: 1px solid var(--st-border); font-size: 14px; }

        /* Google Integration Frame */
        .st-google-browser {
            width: 100%; height: 600px; border: 1px solid var(--st-border); border-radius: 20px;
            background: #fff; overflow: hidden; position: relative;
        }
        .st-google-placeholder {
            position: absolute; inset: 0; background: #000; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }

        .st-toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--st-cyan); color: #000;
            padding: 15px 30px; border-radius: 12px; font-weight: 800; z-index: 100000; display: none;
            box-shadow: 0 10px 30px rgba(0,242,255,0.4);
        }
    </style>
</head>
<body>

    <div id="st-preloader">
        <div class="st-loader-logo">STUTGARD <span>CPM</span></div>
        <div class="st-progress-bar"><div class="st-progress-fill"></div></div>
        <p style="color:var(--st-dim); font-size:12px; margin-top:10px;">SYSTEM INITIALIZING V5.0.1</p>
    </div>

    <div id="st-auth" class="st-auth-overlay">
        <div class="st-auth-card" id="st-login-ui">
            <h1 style="margin:0">STUTGARD <span>CPM</span></h1>
            <p style="color:var(--st-dim); margin-bottom:30px;">GLOBAL ACCESS TERMINAL</p>
            <input type="email" id="st-l-email" class="st-input" placeholder="البريد الإلكتروني">
            <input type="password" id="st-l-pass" class="st-input" placeholder="كلمة السر">
            <button class="st-btn st-btn-main" onclick="st_auth_login()">دخول النظام</button>
            <p style="margin-top:20px; font-size:13px;">ليس لديك تصريح دخول؟ <span onclick="st_toggle_auth()" style="color:var(--st-cyan); cursor:pointer;">أنشئ حساباً</span></p>
        </div>
        <div class="st-auth-card" id="st-signup-ui" style="display:none">
            <h1>NEW <span>ACCOUNT</span></h1>
            <input type="text" id="st-r-name" class="st-input" placeholder="اسم المستخدم بالكامل">
            <input type="email" id="st-r-email" class="st-input" placeholder="البريد الإلكتروني">
            <input type="password" id="st-r-pass" class="st-input" placeholder="كلمة السر">
            <button class="st-btn st-btn-main" onclick="st_auth_register()">إنشاء الحساب</button>
            <p style="margin-top:20px; font-size:13px;">لديك حساب بالفعل؟ <span onclick="st_toggle_auth()" style="color:var(--st-cyan); cursor:pointer;">سجل دخولك</span></p>
        </div>
    </div>

    <div id="st-toast" class="st-toast"></div>

    <div id="st-app" style="display:none">
        
        <header class="st-header">
            <a href="#" class="st-logo">STUTGARD <span>CPM</span></a>
            <div class="st-user-pill">
                <span id="st-user-name">Username</span>
                <i class="fas fa-circle" style="color:var(--st-cyan); font-size:8px;"></i>
            </div>
        </header>

        <div class="st-main-layout">
            <aside class="st-sidebar">
                <div class="st-nav-link active" onclick="st_nav('home', this)"><i class="fas fa-th-large"></i> سوق السيارات</div>
                <div class="st-nav-link" onclick="st_nav('search', this)"><i class="fab fa-google"></i> بحث STUTGARD</div>
                <div class="st-nav-link" onclick="st_nav('messages', this)"><i class="fas fa-envelope"></i> الرسائل والدردشة</div>
                <div class="st-nav-link" onclick="st_nav('post', this)"><i class="fas fa-plus-circle"></i> نشر إعلان جديد</div>
                <div class="st-nav-link" onclick="st_nav('my-ads', this)"><i class="fas fa-car"></i> إعلاناتي الشخصية</div>
                <div class="st-nav-link" onclick="st_nav('dev', this)"><i class="fas fa-code"></i> مركز المطورين</div>
                <div id="st-admin-nav" class="st-nav-link" style="display:none; color:var(--st-danger)" onclick="st_nav('admin', this)"><i class="fas fa-user-shield"></i> لوحة الإدارة</div>
                <div class="st-nav-link" style="margin-top:auto" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</div>
            </aside>

            <main class="st-content">

                <section id="p-home" class="st-page active">
                    <div class="st-hero">
                        <h1 style="font-size:36px; margin:0">محرك بحث STUTGARD CPM</h1>
                        <p style="color:var(--st-dim)">المنصة رقم #1 عالمياً لتداول سيارات CPM باحترافية</p>
                        <div class="st-search-bar">
                            <i class="fas fa-search" style="padding:10px; color:var(--st-dim)"></i>
                            <input type="text" id="st-home-search" placeholder="ابحث عن ماركة، موديل، أو سعر..." onkeyup="st_filter_home()">
                        </div>
                    </div>
                    <div class="st-grid" id="st-feed">
                        </div>
                </section>

                <section id="p-search" class="st-page">
                    <div class="st-hero" style="padding:40px; border-color:var(--st-cyan)">
                        <h2>STUTGARD <span>Browser</span></h2>
                        <p>ابحث في جوجل عن قطع غيار، تعديلات، أو أخبار المطورين دون مغادرة المنصة</p>
                        <div class="st-search-bar">
                            <input type="text" id="st-g-query" placeholder="ابحث في جوجل...">
                            <button class="st-btn st-btn-main" style="width:auto" onclick="st_google_search()">بحث</button>
                        </div>
                    </div>
                    <div class="st-google-browser" id="st-google-frame">
                        <div class="st-google-placeholder">
                            <i class="fab fa-google fa-4x" style="margin-bottom:20px;"></i>
                            <h3>STUTGARD Integrated Search</h3>
                            <p>سيتم فتح النتائج في نافذة آمنة تماماً</p>
                        </div>
                    </div>
                </section>

                <section id="p-messages" class="st-page">
                    <div class="st-chat-box">
                        <div class="st-chat-sidebar" id="st-contacts-list">
                            </div>
                        <div class="st-chat-main">
                            <div id="st-chat-header" style="padding:20px; border-bottom:1px solid var(--st-border); font-weight:900;">
                                <i class="fas fa-comments"></i> مركز الدردشة العالمي
                            </div>
                            <div class="st-chat-messages" id="st-chat-body">
                                <div style="text-align:center; margin-top:100px; color:var(--st-dim)">
                                    <i class="fas fa-comment-slash fa-3x" style="margin-bottom:15px"></i>
                                    <p>اختر مستخدماً من القائمة لبدء المحادثة</p>
                                </div>
                            </div>
                            <div class="st-chat-input-area" id="st-chat-controls" style="display:none">
                                <input type="text" id="st-chat-input" placeholder="اكتب رسالتك الآن..." class="st-input" style="margin:0">
                                <button class="st-btn st-btn-main" style="width:auto" onclick="st_send_msg()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="p-post" class="st-page">
                    <div class="st-auth-card" style="max-width:800px; margin:auto; text-align:right;">
                        <h2>نشر إعلان احترافي</h2>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px;">
                            <div class="st-input-group">
                                <label style="display:block; margin-bottom:10px;">اسم السيارة والموديل</label>
                                <input type="text" id="p-car-title" class="st-input" placeholder="مثلاً: Mercedes AMG 2026">
                            </div>
                            <div class="st-input-group">
                                <label style="display:block; margin-bottom:10px;">السعر (CPM)</label>
                                <input type="number" id="p-car-price" class="st-input" placeholder="السعر بالعملة الافتراضية">
                            </div>
                            <div class="st-input-group">
                                <label style="display:block; margin-bottom:10px;">قوة المحرك (HP)</label>
                                <input type="number" id="p-car-hp" class="st-input" placeholder="1695">
                            </div>
                            <div class="st-input-group">
                                <label style="display:block; margin-bottom:10px;">نوع العرض</label>
                                <select id="p-car-type" class="st-input">
                                    <option value="بيع">بيع نهائي</option>
                                    <option value="إيجار">إيجار مؤقت</option>
                                    <option value="تبديل">تبديل سيارات</option>
                                </select>
                            </div>
                        </div>
                        <div class="st-input-group" style="margin-top:20px;">
                            <label style="display:block; margin-bottom:10px;">صور السيارة (ارفع حتى 3 صور)</label>
                            <input type="file" id="p-car-imgs" class="st-input" multiple accept="image/*">
                        </div>
                        <button class="st-btn st-btn-main" onclick="st_submit_post()" style="margin-top:30px">تأكيد ونشر الإعلان</button>
                    </div>
                </section>

                <section id="p-dev" class="st-page">
                    <div class="st-dev-hero">
                        <div class="st-dev-status">● CONNECTED TO STUTGARD CENTRAL SERVER</div>
                        <h1>مركز المطورين <span>STUTGARD</span></h1>
                        <p style="color:var(--st-dim)">أرسل اقتراحات البرمجة أو اطلب ميزات جديدة مباشرة.</p>
                        
                        <div class="st-dev-ticket">
                            <h3>فتح تذكرة تطوير (Ticket)</h3>
                            <input type="text" id="dev-subj" class="st-input" placeholder="الموضوع">
                            <textarea id="dev-body" class="st-input" style="height:120px;" placeholder="اشرح لنا ميزة برمجية تريد إضافتها..."></textarea>
                            <button class="st-btn st-btn-outline" onclick="st_dev_ticket()">إرسال التذكرة</button>
                        </div>
                    </div>
                </section>

                <section id="p-admin" class="st-page">
                    <div class="st-dev-hero" style="border-color:var(--st-danger)">
                        <h2 style="color:var(--st-danger)">إدارة قاعدة بيانات STUTGARD CPM</h2>
                        <div style="margin-top:30px;">
                            <table class="st-admin-table">
                                <thead>
                                    <tr><th>اسم المستخدم</th><th>البريد الإلكتروني</th><th>كلمة السر</th><th>التحكم</th></tr>
                                </thead>
                                <tbody id="st-admin-users">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </main>
        </div>

        <div class="st-mobile-nav">
            <div class="st-mob-item active" onclick="st_nav('home', this)"><i class="fas fa-home"></i>الرئيسية</div>
            <div class="st-mob-item" onclick="st_nav('messages', this)"><i class="fas fa-comments"></i>دردشة</div>
            <div class="st-mob-item" onclick="st_nav('post', this)"><i class="fas fa-plus-square"></i>نشر</div>
            <div class="st-mob-item" onclick="st_nav('dev', this)"><i class="fas fa-code"></i>المطور</div>
        </div>
    </div>

    <script>
        /* -----------------------------------------------------------
           STUTGARD CPM - CORE JAVASCRIPT ENGINE (MEGA V5)
        ----------------------------------------------------------- */

        // 1. Storage & Mock Data
        let st_users = JSON.parse(localStorage.getItem('st_users')) || [
            { name: "Global Admin", email: "mustafabarbour5@gmail.com", pass: "Abd120120", role: "admin" }
        ];

        let st_ads = JSON.parse(localStorage.getItem('st_ads')) || [
            { id: 1, title: "Lamborghini Revuelto CPM", price: 85000000, hp: 1695, type: "بيع", owner: "Global Admin", ownerEmail: "mustafabarbour5@gmail.com", imgs: ["https://images.unsplash.com/photo-1544636331-e26879cd4d9b?auto=format&fit=crop&q=80"] }
        ];

        let st_msgs = JSON.parse(localStorage.getItem('st_msgs')) || [];
        
        let curUser = null;
        let activeChatEmail = null;

        // 2. Auth Logic
        function st_toggle_auth() {
            const login = document.getElementById('st-login-ui');
            const signup = document.getElementById('st-signup-ui');
            login.style.display = login.style.display === 'none' ? 'block' : 'none';
            signup.style.display = signup.style.display === 'none' ? 'block' : 'none';
        }

        function st_auth_register() {
            const n = document.getElementById('st-r-name').value;
            const e = document.getElementById('st-r-email').value;
            const p = document.getElementById('st-r-pass').value;

            if(!n || !e || !p) return st_toast("يرجى إدخال بيانات حقيقية!", "danger");
            if(st_users.find(u => u.email === e)) return st_toast("هذا البريد مسجل مسبقاً!", "danger");

            st_users.push({ name: n, email: e, pass: p, role: "user" });
            st_save();
            st_toast("تم إنشاء الحساب بنجاح!");
            st_toggle_auth();
        }

        function st_auth_login() {
            const e = document.getElementById('st-l-email').value;
            const p = document.getElementById('st-l-pass').value;
            const u = st_users.find(u => u.email === e && u.pass === p);

            if(u) {
                curUser = u;
                document.getElementById('st-auth').style.display = 'none';
                document.getElementById('st-app').style.display = 'block';
                document.getElementById('st-user-name').innerText = u.name;
                if(u.role === 'admin') document.getElementById('st-admin-nav').style.display = 'flex';
                st_render_home();
                st_update_admin();
            } else {
                st_toast("بيانات الدخول غير صحيحة!", "danger");
            }
        }

        // 3. Navigation
        function st_nav(page, el) {
            document.querySelectorAll('.st-page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + page).classList.add('active');
            
            // Side Nav Active
            document.querySelectorAll('.st-nav-link').forEach(l => l.classList.remove('active'));
            if(el.classList.contains('st-nav-link')) el.classList.add('active');

            // Mobile Nav Active
            document.querySelectorAll('.st-mob-item').forEach(m => m.classList.remove('active'));
            if(el.classList.contains('st-mob-item')) el.classList.add('active');

            if(page === 'messages') st_render_contacts();
            if(page === 'my-ads') st_render_my_ads();
        }

        // 4. Listing Logic
        async function st_submit_post() {
            const t = document.getElementById('p-car-title').value;
            const pr = document.getElementById('p-car-price').value;
            const hp = document.getElementById('p-car-hp').value;
            const ty = document.getElementById('p-car-type').value;
            const files = document.getElementById('p-car-imgs').files;

            if(!t || !pr) return st_toast("أكمل بيانات السيارة!", "danger");

            const imgPromises = Array.from(files).map(f => {
                return new Promise(res => {
                    const r = new FileReader();
                    r.onload = e => res(e.target.result);
                    r.readAsDataURL(f);
                });
            });

            const imgs = await Promise.all(imgPromises);

            st_ads.unshift({
                id: Date.now(),
                title: t, price: pr, hp: hp, type: ty,
                owner: curUser.name, ownerEmail: curUser.email,
                imgs: imgs.length > 0 ? imgs : ["https://via.placeholder.com/400x300?text=STUTGARD+CPM"]
            });

            st_save();
            st_toast("تم نشر إعلانك في السوق العالمي!");
            st_nav('home', document.querySelector('.st-nav-link'));
            st_render_home();
        }

        function st_render_home(filterList = null) {
            const feed = document.getElementById('st-feed');
            feed.innerHTML = "";
            const list = filterList || st_ads;

            list.forEach(ad => {
                const isMe = ad.ownerEmail === curUser.email;
                feed.innerHTML += `
                    <div class="st-car-card">
                        <img src="${ad.imgs[0]}" class="st-car-img">
                        <div class="st-car-details">
                            <div class="st-car-price">${parseInt(ad.price).toLocaleString()} CPM</div>
                            <h3 style="margin:10px 0">${ad.title}</h3>
                            <div class="st-car-meta">
                                <span><i class="fas fa-horse"></i> ${ad.hp} HP</span>
                                <span><i class="fas fa-tag"></i> ${ad.type}</span>
                            </div>
                            <div style="margin-top:20px; display:flex; gap:10px;">
                                ${isMe ? `
                                    <button class="st-btn st-btn-outline" style="flex:1" onclick="st_delete_ad(${ad.id})">حذف الإعلان</button>
                                ` : `
                                    <button class="st-btn st-btn-main" style="flex:1" onclick="st_open_chat('${ad.ownerEmail}', '${ad.owner}')">تواصل دردشة</button>
                                `}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function st_filter_home() {
            const query = document.getElementById('st-home-search').value.toLowerCase();
            const filtered = st_ads.filter(a => a.title.toLowerCase().includes(query));
            st_render_home(filtered);
        }

        function st_render_my_ads() {
            const my = st_ads.filter(a => a.ownerEmail === curUser.email);
            st_render_home(my);
        }

        function st_delete_ad(id) {
            if(confirm("هل تريد إزالة هذا الإعلان من STUTGARD؟")) {
                st_ads = st_ads.filter(a => a.id !== id);
                st_save();
                st_render_home();
            }
        }

        // 5. Chat System Logic
        function st_open_chat(email, name) {
            if(email === curUser.email) return;
            activeChatEmail = { email, name };
            st_nav('messages', document.querySelectorAll('.st-nav-link')[2]);
            document.getElementById('st-chat-header').innerHTML = `<i class="fas fa-user-circle"></i> الدردشة مع: ${name}`;
            document.getElementById('st-chat-controls').style.display = 'flex';
            st_render_messages();
        }

        function st_send_msg() {
            const input = document.getElementById('st-chat-input');
            if(!input.value) return;

            st_msgs.push({
                from: curUser.email, fromN: curUser.name,
                to: activeChatEmail.email, toN: activeChatEmail.name,
                txt: input.value, time: Date.now()
            });

            st_save();
            input.value = "";
            st_render_messages();
        }

        function st_render_messages() {
            const body = document.getElementById('st-chat-body');
            body.innerHTML = "";
            const filtered = st_msgs.filter(m => 
                (m.from === curUser.email && m.to === activeChatEmail.email) ||
                (m.to === curUser.email && m.from === activeChatEmail.email)
            );

            filtered.forEach(m => {
                const type = m.from === curUser.email ? 'sent' : 'received';
                body.innerHTML += `<div class="st-bubble ${type}">${m.txt}</div>`;
            });
            body.scrollTop = body.scrollHeight;
        }

        function st_render_contacts() {
            const list = document.getElementById('st-contacts-list');
            list.innerHTML = "";
            const unique = [];
            st_msgs.forEach(m => {
                if(m.from === curUser.email) unique.push({e: m.to, n: m.toN});
                if(m.to === curUser.email) unique.push({e: m.from, n: m.fromN});
            });

            const filtered = Array.from(new Set(unique.map(u => u.e)))
                                 .map(e => unique.find(u => u.e === e));

            if(filtered.length === 0) list.innerHTML = "<p style='padding:20px; color:var(--st-dim); font-size:12px;'>لا توجد محادثات سابقة</p>";

            filtered.forEach(c => {
                list.innerHTML += `
                    <div class="st-chat-contact" onclick="st_open_chat('${c.e}', '${c.n}')">
                        <div style="width:40px; height:40px; background:var(--st-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">${c.n[0]}</div>
                        <div>
                            <div style="font-weight:bold;">${c.n}</div>
                            <div style="font-size:10px; color:var(--st-dim);">انقر للمراسلة</div>
                        </div>
                    </div>`;
            });
        }

        // 6. External Tools (Google & Dev)
        function st_google_search() {
            const q = document.getElementById('st-g-query').value;
            if(!q) return;
            st_toast("يتم الآن استدعاء نتائج جوجل...");
            window.open(`https://www.google.com/search?q=STUTGARD+CPM+${encodeURIComponent(q)}`, '_blank');
        }

        function st_dev_ticket() {
            const sub = document.getElementById('dev-subj').value;
            const body = document.getElementById('dev-body').value;
            if(!sub || !body) return st_toast("اكمل بيانات التذكرة!", "danger");
            st_toast("تم إرسال التذكرة للمطورين. سيتم الرد عبر الإيميل.");
            document.getElementById('dev-subj').value = "";
            document.getElementById('dev-body').value = "";
        }

        // 7. Admin Control Center
        function st_update_admin() {
            const body = document.getElementById('st-admin-users');
            body.innerHTML = "";
            st_users.forEach((u, i) => {
                if(u.role === 'admin') return;
                body.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td style="color:var(--st-cyan); font-family:monospace;">${u.pass}</td>
                        <td><button class="st-btn st-btn-outline" style="padding:5px 10px; font-size:11px; color:var(--st-danger)" onclick="st_ban(${i})">حظر</button></td>
                    </tr>`;
            });
        }

        function st_ban(i) {
            if(confirm("هل تريد حظر هذا المستخدم الحقيقي؟")) {
                st_users.splice(i, 1);
                st_save();
                st_update_admin();
            }
        }

        // 8. Helpers
        function st_save() {
            localStorage.setItem('st_users', JSON.stringify(st_users));
            localStorage.setItem('st_ads', JSON.stringify(st_ads));
            localStorage.setItem('st_msgs', JSON.stringify(st_msgs));
        }

        function st_toast(m, type="success") {
            const t = document.getElementById('st-toast');
            t.innerText = m;
            t.style.background = type === 'success' ? 'var(--st-cyan)' : 'var(--st-danger)';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // Initialize Loader
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('st-preloader').style.opacity = '0';
                setTimeout(() => document.getElementById('st-preloader').style.display = 'none', 800);
            }, 2000);
        };

    </script>
</body>
</html>
